<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IA.Nanda Mac â€“ Assistente de Alunos</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    /* Overlay de Loading */
    #loadingOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.8);
      display: flex; align-items: center; justify-content: center;
      font-size: 1.2rem; color: #333;
      z-index: 999; visibility: hidden;
    }
    #loadingOverlay.visible { visibility: visible; }
    .container {
      max-width: 600px;
      margin: 80px auto;
      padding: 20px;
      font-family: Arial, sans-serif;
      color: #333;
    }
    h1 { text-align: center; margin-bottom: 10px; }
    p.subtitle { text-align: center; margin-bottom: 30px; color: #555; }
    #chatHistory {
      max-width: 600px;
      margin: 20px auto 30px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #fafafa;
      max-height: 300px;
      overflow-y: auto;
    }
    textarea {
      width: 100%; padding: 10px; font-size: 1rem;
      border: 1px solid #ccc; border-radius: 4px; resize: vertical;
    }
    button {
      display: block; margin-top: 15px;
      padding: 10px 20px; font-size: 1rem;
      background-color: #005fa3; color: #fff;
      border: none; border-radius: 4px; cursor: pointer;
    }
    button:disabled { background-color: #999; cursor: not-allowed; }
    #errorMessage { color: red; display: none; margin-top: 10px; }
  </style>
</head>
<body>

  <div id="loadingOverlay">
    <div>
      <svg width="50" height="50" viewBox="0 0 100 100" fill="none"
           xmlns="http://www.w3.org/2000/svg">
        <circle cx="50" cy="50" r="45" stroke="#555" stroke-width="10"
                stroke-linecap="round" stroke-dasharray="283"
                stroke-dashoffset="75">
          <animateTransform attributeName="transform" type="rotate"
            repeatCount="indefinite" dur="1s"
            from="0 50 50" to="360 50 50" />
        </circle>
      </svg>
      <p>Aguarde, a IA.Nanda Mac estÃ¡ pensando...</p>
    </div>
  </div>

  <div class="container">
    <h1>ðŸ’¡ Bem-vindo(a) Ã  IA.Nanda Mac</h1>
    <p class="subtitle">
      Seu suporte exclusivo 24h para o Curso ConsultÃ³rio High Ticket, pela IA.Nanda Mac.
    </p>

    <div id="chatHistory"></div>

    <form id="askForm">
      <textarea id="question" name="question"
        placeholder="Digite sua dÃºvida sobre o curso â€“ a IA.Nanda Mac responde"
        rows="4"></textarea>
      <button type="submit">Perguntar Ã  IA.Nanda Mac</button>
      <p id="errorMessage">Por favor, escreva sua dÃºvida para a IA.Nanda Mac responder.</p>
    </form>
  </div>

  <script>
    const form = document.getElementById('askForm');
    const questionInput = document.getElementById('question');
    const errorMessage = document.getElementById('errorMessage');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const chatHistory = document.getElementById('chatHistory');
    const submitBtn = form.querySelector('button[type="submit"]');

    form.addEventListener('submit', async e => {
      e.preventDefault();
      const q = questionInput.value.trim();
      if (!q) {
        errorMessage.style.display = 'block';
        return;
      }
      errorMessage.style.display = 'none';
      loadingOverlay.classList.add('visible');
      submitBtn.disabled = true;

      const res = await fetch('/ask', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'Accept': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: new URLSearchParams({ question: q })
      });

      loadingOverlay.classList.remove('visible');
      submitBtn.disabled = false;

      if (!res.ok) {
        alert('Erro ao enviar a pergunta.');
        return;
      }

      const { question, answer } = await res.json();

      const qEl = document.createElement('div');
      qEl.textContent = 'VocÃª: ' + question;
      qEl.style.fontWeight = 'bold';
      chatHistory.appendChild(qEl);

      const aEl = document.createElement('div');
      aEl.textContent = 'IA.Nanda Mac: ' + answer;
      aEl.style.marginBottom = '1.5rem';
      chatHistory.appendChild(aEl);

      chatHistory.scrollTop = chatHistory.scrollHeight;
      questionInput.value = '';
      questionInput.focus();
    });
  </script>

</body>
</html>
